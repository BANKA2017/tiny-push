<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta name="robots" content="nofollow" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="author" content="Banka2017 (https://nest.moe)" />
        <meta name="description" content="TinyPush" />
        <meta name="theme-color" content="#212529" />
        <link rel="apple-touch-icon" href="/icon.png">
        <link rel="icon" href="/icon.png">
        <link rel="manifest" href="/manifest.webmanifest" />
        <title>TinyPush</title>
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
        <style>
            a::after {
                content: ' ↗';
            }
        </style>
    </head>

    <body style="display: flex; justify-content: center; height: 90vh; margin: 20px; flex-direction: column">
        <div id="app" class="d-flex justify-content-center" style="overflow-y: auto">
            <div style="max-width: 600px">
                <div v-if="message.content">
                    <button class="btn btn-sm btn-danger" style="position: fixed; right: 2rem; top: 2rem; width: 3; height: 3rem" @click="pushState({ name: 'main' }, '.')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                        </svg>
                    </button>
                    <div class="text-end" style="position: fixed; display: flex; flex-direction: column; right: 2rem; bottom: 2rem">
                        <small>
                            <span class="me-2"
                                ><code class="text-break" :title="message.sign ? message.sign : '<unsigned>'" @click="(e) => {clickEvent(e, () => {message.longSign=!message.longSign})}"
                                    >{{ message.sign ? (message.longSign ? message.sign : message.sign.slice(0, 12)) : '&lt;unsigned&gt;' }}</code
                                ></span
                            >
                            <span style="display: inline-block">
                                <svg v-if="message.verify " xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32">
                                    <g fill="none">
                                        <path fill="#00D26A" d="M2 6a4 4 0 0 1 4-4h20a4 4 0 0 1 4 4v20a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4z" />
                                        <path
                                            fill="#F4F4F4"
                                            d="M13.242 23c-.383 0-.766-.143-1.059-.43l-5.744-5.642a1.453 1.453 0 0 1 0-2.08a1.517 1.517 0 0 1 2.118 0l4.685 4.601L23.443 9.431a1.517 1.517 0 0 1 2.118 0a1.452 1.452 0 0 1 0 2.08l-11.26 11.058a1.503 1.503 0 0 1-1.059.431"
                                        />
                                    </g>
                                </svg>
                                <svg v-else xmlns="http://www.w3.org/2000/svg" width="0.75em" height="0.75em" viewBox="0 0 32 32">
                                    <path
                                        fill="#F92F60"
                                        d="M24.879 2.879A3 3 0 1 1 29.12 7.12l-8.79 8.79a.125.125 0 0 0 0 .177l8.79 8.79a3 3 0 1 1-4.242 4.243l-8.79-8.79a.125.125 0 0 0-.177 0l-8.79 8.79a3 3 0 1 1-4.243-4.242l8.79-8.79a.125.125 0 0 0 0-.177l-8.79-8.79A3 3 0 0 1 7.12 2.878l8.79 8.79a.125.125 0 0 0 .177 0z"
                                    />
                                </svg>
                            </span>
                        </small>
                        <small class="" v-if="messageDate">
                            <span><code :title="message.timestamp">{{ messageDate }}</code></span>
                        </small>
                    </div>
                    <div :title="message.content" @click="(e) => {clickEvent(e, () => {message.originalMode=!message.originalMode})}">
                        <template v-if="message.originalMode">
                            <p class="text-break" v-for="(_message, i) in message.content.trim().split('\n')" :key="i">{{ _message }}</p>
                        </template>
                        <template v-else>
                            <template v-for="(_message, i) in messageObject" :key="i">
                                <template class="text-break" v-for="(__message, ii) in _message.str.split('\n')" :key="''+i+'_'+ii"> <br v-if="ii !== 0" /><span>{{ __message }}</span> </template>
                                <a v-if="_message.link" :href="_message.link.href" target="_blank" @click="(e)=>{e.stopPropagation()}">{{ _message.link.name }}</a>
                            </template>
                        </template>
                    </div>
                </div>
                <div v-else>
                    <h1 class="text-center mb-2">
                        <div style="display: inline-block; transform: translateY(-0.1em)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32">
                                <g fill="none">
                                    <path fill="#FF822D" d="M12.5 27.5c.448 1.442 1.838 2.5 3.5 2.5c1.663 0 3.052-1.058 3.5-2.5z" />
                                    <path fill="#FFB02E" d="M16 6.55c-.69 0-1.25-.56-1.25-1.25V3.25a1.25 1.25 0 0 1 2.5 0V5.3c0 .69-.56 1.25-1.25 1.25" />
                                    <path
                                        fill="#F9C23C"
                                        d="M27.6 22.843c-.96-.773-1.54-1.927-1.78-3.15l-1.73-8.9C23.32 6.85 19.94 4.01 16 4c-3.94.01-7.32 2.85-8.09 6.793l-1.73 8.9c-.24 1.223-.82 2.377-1.78 3.15a3.783 3.783 0 0 0-1.4 2.95v1.234c0 .542.43.973.95.973h24.1c.53 0 .95-.431.95-.973v-1.234c0-1.204-.55-2.258-1.4-2.95"
                                    />
                                </g>
                            </svg>
                        </div>
                        <span>TinyPush</span>
                    </h1>
                    <button v-if="pushStatus === 'wait'" class="btn btn-primary mb-2" @click="initPushConfig" style="width: 100%">Subscribe</button>
                    <button v-if="pushStatus === 'granted'" class="btn btn-danger mb-2" @click="unSubscribe" style="width: 100%">Unsubscribe</button>
                    <p v-else-if="pushStatus === 'no'" class="text-center">The browser does not support notifications.</p>
                    <p v-else-if="pushStatus === 'denied'" class="text-center">Please allow the browser to use notification.</p>
                    <p class="text-center">If on iOS, add this page to the Home Screen for it to work.</p>
                    <details v-if="['granted', 'wait'].includes(pushStatus)">
                        <summary class="text-center">UUID / Key / Auth / VAPID</summary>
                        <div class="mb-3 mt-2">
                            <label class="form-label" for="uuid">UUID</label>
                            <div class="input-group">
                                <input id="uuid" type="text" class="form-control" :value="uuid" />
                            </div>
                        </div>
                        <hr />

                        <details>
                            <summary class="text-center">MORE</summary>
                            <div class="mb-3">
                                <label class="form-label" for="vapid">VAPID</label>
                                <div class="input-group">
                                    <input id="vapid" type="text" class="form-control" :value="vapid" />
                                </div>
                                <div class="form-text" id="form-text-vapid">Public key for application</div>
                            </div>
                            <hr />
                            <div class="mb-3">
                                <label class="form-label" for="public-key">PublicKey</label>
                                <div class="input-group">
                                    <input id="public-key" type="text" class="form-control" :value="publicKey" />
                                </div>
                            </div>
                            <hr />
                            <div class="mb-3">
                                <label class="form-label" for="auth">Auth</label>
                                <div class="input-group">
                                    <input id="auth" type="text" class="form-control" :value="auth" />
                                </div>
                            </div>
                            <hr />
                            <div class="mb-3">
                                <label class="form-label" for="endpoint">Endpoint</label>
                                <div class="input-group">
                                    <input id="endpoint" type="text" class="form-control" :value="endpoint" />
                                </div>
                            </div>
                            <hr />
                        </details>

                        <div class="mb-3">
                            <label class="form-label" for="message">Message</label>
                            <div class="input-group">
                                <textarea rows="5" id="message" class="form-control" v-model="test_message"></textarea>
                            </div>
                        </div>
                        <hr />
                        <button v-if="pushStatus === 'granted'" class="btn btn-danger mb-2" @click="testPush" style="width: 100%">PUSH!</button>
                    </details>
                    <p class="text-end"><span @click="pushState({ name: 'help' }, './#/help')" role="button" class="me-2">#help</span><span @click="pushState({ name: 'about' }, './#/about')" role="button">#about</span></p>
                </div>
            </div>
        </div>
        <!--load css and js-->
        <script src="https://cdn.jsdelivr.net/npm/vue@3.4.24/dist/vue.global.prod.js" integrity="sha256-NuLZKbx8rSWxfBrjvEqgCUKQ+dIBM3WUKEOAqw/NfIw=" crossorigin="anonymous"></script>
        <script>
            const endpoint = '.'
            const { createApp } = Vue
            createApp({
                data: () => ({
                    pushStatus: '',
                    vapid: '',
                    publicKey: '',
                    auth: '',
                    endpoint: '',
                    uuid: '',
                    message: {
                        content: '',
                        sign: '',
                        verify: false,
                        timestamp: 0
                    },
                    route: ['main']
                }),

                computed: {
                    messageObject() {
                        if (this.message.content === '') {
                            return []
                        }
                        const links = this.parseLinks(this.message.content)
                        return this.newMessageObject(this.message.content, links)
                    },
                    messageDate() {
                        if (!this.message.timestamp) {
                            return ''
                        }
                        try {
                            const tmpDate = new Date(this.message.timestamp)
                            //4:22 PM · 19 Aug, 2022
                            return `${tmpDate.getFullYear()}-${(tmpDate.getMonth() + 1).toString().padStart(2, '0')}-${tmpDate.getDate().toString().padStart(2, '0')} · ${tmpDate.getHours()}:${tmpDate
                                .getMinutes()
                                .toString()
                                .padStart(2, '0')}:${tmpDate.getSeconds().toString().padStart(2, '0')}`
                        } catch (e) {
                            console.error(e)
                            return ''
                        }
                    }
                },
                watch: {
                    async vapid(newVal, oldVal) {
                        if (newVal != '' && this.route?.[0] === 'preview') {
                            this.message.verify = await this.verifySign(this.message.content || '', this.message.sign || '')
                        }
                    },
                    async route(newVal, oldVal) {
                        if (newVal.length < 1) {
                            return
                        }
                        switch (newVal[0]) {
                            case 'preview':
                                const hashContent = JSON.parse(atob(newVal[1]))
                                const content = new TextDecoder('utf-8').decode(this.base64_to_buffer(this.base64url_to_base64(hashContent.content)))
                                //console.log(hashContent, content)
                                this.message = { content, sign: hashContent?.sign || '', verify: await this.verifySign(content, hashContent?.sign || ''), timestamp: Number(hashContent?.timestamp || 0) }
                                break
                            case 'about':
                                this.message = {
                                    content: `TinyPush is a tiny tool to push content via WebPush 🚀\n\n1️⃣ Click on text to display original text\n\n2️⃣ A ✅ displayed in the lower right corner indicates that the signature verification has been passed.\n\n3️⃣ Click \`UUID / Key / Auth / VAPID\` on the homepage to view the content. After entering the content in message, click **PUSH!** to push the test message.\n\n4️⃣ Please keep the uuid safe, anyone with a uuid can push messages to this device. If the uuid is leaked, please re-apply for a subscription after unsubscribing on the homepage.\n\n5️⃣ The currently supported markdown syntax is only links ( \`[]()\` or \`<>\` )\n\nTo learn more, please visit [github:BANKA2017/tiny-push](https://github.com/BANKA2017/tiny-push)\n`,
                                    sign: 'build-in',
                                    verify: true
                                }
                                break
                            case 'help':
                                this.message = {
                                    content: 'step by step\n\n\nuuid="" # Get the uuid from the target client\nmessage="" # What to push\ncurl -XPOST "https://push.nest.moe/push/$uuid" -d "message=$message"\n',
                                    sign: 'build-in',
                                    verify: true
                                }
                            case 'import':
                                break
                            case 'main':
                                this.message = { content: '', sign: '', verify: false, timestamp: 0 }
                                break
                        }
                        //console.log(newVal, oldVal)
                    }
                },

                mounted: async function () {
                    this.updateNotifitionPermission()
                    this.subscribeStatus()
                    this.publicKey = localStorage.getItem('push:public_key') || ''
                    this.auth = localStorage.getItem('push:auth') || ''
                    this.endpoint = localStorage.getItem('push:endpoint') || ''
                    this.uuid = localStorage.getItem('push:uuid') || ''

                    this.routerCase(location.hash)
                    addEventListener('popstate', (event) => {
                        this.routerCase(event.target.location.hash)
                    })

                    fetch(endpoint + '/vapid')
                        .then((res) => res.json())
                        .then(async (res) => {
                            this.vapid = res.data.vapid
                        })
                        .catch((e) => {
                            console.error(e)
                        })
                },
                methods: {
                    routerCase: function (to) {
                        if (!to) {
                            to = this.route = ['main']
                            return
                        }
                        to = to.split('#')
                        if (to.length < 2) {
                            return // invalid path
                        }
                        to = to.slice(1).join('').split('/')
                        if (!to[1]) {
                            return // invalid path
                        } else {
                            this.route = to.slice(1)
                        }
                    },
                    updateNotifitionPermission: function () {
                        if (!('Notification' in window)) {
                            this.pushStatus = 'no'
                        } else if (Notification.permission === 'granted') {
                            this.pushStatus = 'granted'
                        } else if (Notification.permission === 'denied') {
                            this.pushStatus = 'denied'
                        } else {
                            this.pushStatus = 'wait'
                        }
                    },
                    initPushConfig: function () {
                        switch (this.pushStatus) {
                            case 'no':
                            case 'granted':
                                return
                            case 'wait':
                                Notification.requestPermission().then((permission) => {
                                    this.pushStatus = permission
                                })
                                break
                            case 'denied':
                                return
                        }
                        this.subscribe()
                    },
                    subscribeStatus: function () {
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager.getSubscription().then((subscription) => {
                                if (!subscription) {
                                    this.pushStatus = 'wait'
                                }
                            })
                        })
                    },
                    subscribe: function () {
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager
                                .subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: this.vapid
                                })
                                .then((sub) => {
                                    sub = sub.toJSON()
                                    this.publicKey = sub.keys.p256dh
                                    this.auth = sub.keys.auth
                                    this.endpoint = sub.endpoint
                                    localStorage.setItem('push:public_key', this.publicKey)
                                    localStorage.setItem('push:auth', this.auth)
                                    localStorage.setItem('push:endpoint', this.endpoint)
                                    fetch(endpoint + '/subscribe/', {
                                        headers: {
                                            'content-type': 'application/x-www-form-urlencoded'
                                        },
                                        method: 'PUT',
                                        body: new URLSearchParams({
                                            endpoint: this.endpoint,
                                            p256dh: this.publicKey,
                                            auth: this.auth
                                        }).toString()
                                    })
                                        .then((res) => res.json())
                                        .then((res) => {
                                            //console.log(res, res.code, res.data)
                                            if (res.code === 200) {
                                                this.uuid = res.data.uuid
                                                localStorage.setItem('push:uuid', this.uuid)
                                            }
                                        })
                                })
                        })
                    },
                    unSubscribe: function () {
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager
                                .getSubscription()
                                .then((subscription) => {
                                    subscription.unsubscribe().then((successful) => {
                                        if (this.uuid) {
                                            fetch(endpoint + '/subscribe/' + this.uuid, {
                                                headers: {
                                                    'content-type': 'application/x-www-form-urlencoded'
                                                },
                                                method: 'DELETE'
                                            })
                                                .then((res) => res.json())
                                                .then((res) => {
                                                    //console.log(res)
                                                })
                                                .catch((e) => {
                                                    console.error(res)
                                                })
                                        }
                                    })
                                    localStorage.removeItem('push:public_key')
                                    localStorage.removeItem('push:auth')
                                    localStorage.removeItem('push:endpoint')
                                    localStorage.removeItem('push:uuid')
                                    this.publicKey = ''
                                    this.auth = ''
                                    this.endpoint = ''
                                    this.uuid = ''
                                    this.pushStatus = 'wait'
                                })
                                .catch((e) => {
                                    console.error(e)
                                })
                        })
                    },
                    download: function (filename, text) {
                        let element = document.createElement('a')
                        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text))
                        element.setAttribute('download', filename)
                        element.style.display = 'none'
                        document.body.appendChild(element)
                        element.click()
                        document.body.removeChild(element)
                    },
                    base64_to_base64url: (base64) => base64.replaceAll('/', '_').replaceAll('+', '-').replaceAll('=', ''),
                    base64url_to_base64: (base64url) => base64url.replaceAll('_', '/').replaceAll('-', '+'),
                    base64_to_buffer: function (base64) {
                        let binaryString = atob(base64)
                        let bytes = new Uint8Array(binaryString.length)
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i)
                        }
                        return bytes.buffer
                    },
                    testPush: function () {
                        fetch(endpoint + '/push/' + this.uuid, {
                            headers: {
                                'content-type': 'application/x-www-form-urlencoded'
                            },
                            method: 'POST',
                            body: new URLSearchParams({
                                endpoint: this.endpoint,
                                p256dh: this.publicKey,
                                auth: this.auth,
                                message: this.test_message
                            }).toString()
                        })
                            .then((res) => res.json())
                            .then((res) => {
                                //console.log(res)
                            })
                            .catch((e) => {
                                console.error(e)
                            })
                    },
                    clickEvent: function (e, callback = () => {}) {
                        let selectionObject = window.getSelection()
                        if (selectionObject && selectionObject.isCollapsed) {
                            callback()
                        }
                    },
                    verifySign: async function (content = '', sign = '') {
                        if (!sign || !this.vapid) {
                            return false
                        }
                        const publicKey = await crypto.subtle.importKey(
                            'raw',
                            this.base64_to_buffer(this.base64url_to_base64(this.vapid)),
                            {
                                name: 'ECDSA',
                                namedCurve: 'P-256'
                            },
                            true,
                            ['verify']
                        )
                        return await crypto.subtle.verify(
                            {
                                name: 'ECDSA',
                                hash: { name: 'SHA-256' }
                            },
                            publicKey,
                            this.base64_to_buffer(this.base64url_to_base64(sign)),
                            new TextEncoder().encode(content)
                        )
                    },
                    parseLinks: function (str = '') {
                        if (!str) {
                            return []
                        }
                        const matchLinks = this.PregMatchAll(/\[([^\]]+)\]\(([^)]+)\)|<([^>]+)>/g, str)
                        const links = []
                        let position = 0
                        for (const i in matchLinks[0]) {
                            position = str.indexOf(matchLinks[0][i], position)
                            const rename = matchLinks[2][i] !== undefined
                            links.push({
                                href: matchLinks[rename ? 2 : 3][i],
                                name: matchLinks[rename ? 1 : 3][i],
                                position,
                                length: matchLinks[0][i].length
                            })
                            position += matchLinks[0][i].length
                        }
                        return links
                    },
                    newMessageObject: function (str = '', links = []) {
                        const strLength = str.length
                        const newArray = []
                        let position = 0
                        for (const link of links) {
                            newArray.push({
                                str: str.slice(position, link.position),
                                link
                            })
                            position = link.position + link.length
                        }
                        if (position < strLength) {
                            newArray.push({
                                str: str.slice(position)
                            })
                        }
                        return newArray
                    },
                    PregMatchAll: (regex = new RegExp('', 'gm'), text = '') => {
                        let handle
                        let match = []

                        while ((handle = regex.exec(text)) !== null) {
                            // This is necessary to avoid infinite loops with zero-width matches
                            if (handle.index === regex.lastIndex) {
                                regex.lastIndex++
                            }
                            for (const index in handle) {
                                if (!isNaN(index)) {
                                    if (!match[index]) {
                                        match[index] = []
                                    }
                                    match[index].push(handle[index])
                                }
                            }
                        }
                        return match
                    },
                    pushState: function (state = {}, url) {
                        state = { ...state, url }
                        history.pushState(state, '', url)
                        dispatchEvent(new PopStateEvent('popstate', { state }))
                    }
                }
            }).mount('#app')
        </script>
        <script async>
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('./sw.js')
                    .then((reg) => {
                        //console.log('register a service worker: ', reg)
                    })
                    .catch((err) => {
                        console.log('err: ', err)
                    })
            }
        </script>
    </body>
</html>
