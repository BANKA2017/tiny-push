<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta name="robots" content="nofollow" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="author" content="Banka2017 (https://nest.moe)" />
        <meta name="description" content="TinyPush" />
        <meta name="theme-color" content="#212529" />
        <link rel="apple-touch-icon" href="/icon.png" />
        <link rel="icon" href="/icon.png" />
        <link rel="manifest" href="/manifest.webmanifest" />
        <title>TinyPush</title>
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
        <style>
            a::after {
                content: ' ‚Üó';
            }
        </style>
    </head>

    <body style="display: flex; justify-content: center; height: 90vh; margin: 20px; flex-direction: column">
        <div id="app" class="d-flex justify-content-center" style="overflow-y: auto">
            <div style="max-width: 600px; width: 95vw">
                <div v-if="message.content" style="padding-top: 5rem; padding-bottom: 2rem">
                    <button class="btn btn-sm btn-danger" style="position: fixed; right: 2rem; top: 2rem; width: 3rem; height: 3rem" @click="pushState({ name: 'main' }, '.')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="2rem" height="2rem" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708" />
                        </svg>
                    </button>
                    <div class="text-end" style="position: fixed; display: flex; flex-direction: column; right: 2rem; bottom: 2rem">
                        <small>
                            <span class="me-2"
                                ><code class="text-break" :title="message.sign ? message.sign : '<unsigned>'" @click="(e) => {clickEvent(e, () => {message.longSign=!message.longSign})}"
                                    >{{ message.sign ? (message.longSign ? message.sign : message.sign.slice(0, 12)) : '&lt;unsigned&gt;' }}</code
                                ></span
                            >
                            <span style="display: inline-block">
                                <svg v-if="message.verify " xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32">
                                    <g fill="none">
                                        <path fill="#00D26A" d="M2 6a4 4 0 0 1 4-4h20a4 4 0 0 1 4 4v20a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4z" />
                                        <path
                                            fill="#F4F4F4"
                                            d="M13.242 23c-.383 0-.766-.143-1.059-.43l-5.744-5.642a1.453 1.453 0 0 1 0-2.08a1.517 1.517 0 0 1 2.118 0l4.685 4.601L23.443 9.431a1.517 1.517 0 0 1 2.118 0a1.452 1.452 0 0 1 0 2.08l-11.26 11.058a1.503 1.503 0 0 1-1.059.431"
                                        />
                                    </g>
                                </svg>
                                <svg v-else xmlns="http://www.w3.org/2000/svg" width="0.75em" height="0.75em" viewBox="0 0 32 32">
                                    <path
                                        fill="#F92F60"
                                        d="M24.879 2.879A3 3 0 1 1 29.12 7.12l-8.79 8.79a.125.125 0 0 0 0 .177l8.79 8.79a3 3 0 1 1-4.242 4.243l-8.79-8.79a.125.125 0 0 0-.177 0l-8.79 8.79a3 3 0 1 1-4.243-4.242l8.79-8.79a.125.125 0 0 0 0-.177l-8.79-8.79A3 3 0 0 1 7.12 2.878l8.79 8.79a.125.125 0 0 0 .177 0z"
                                    />
                                </svg>
                            </span>
                        </small>
                        <small class="" v-if="messageDate">
                            <span><code :title="message.timestamp">{{ messageDate }}</code></span>
                        </small>
                    </div>
                    <div :title="message.content">
                        <template v-if="message.originalMode">
                            <p class="text-break" v-for="(_message, i) in message.content.trim().split('\n')" :key="i">{{ _message }}</p>
                        </template>
                        <template v-else>
                            <template v-for="(_message, i) in messageObject" :key="i">
                                <template class="text-break" v-for="(__message, ii) in _message.str.split('\n')" :key="''+i+'_'+ii"> <br v-if="ii !== 0" /><span>{{ __message }}</span> </template>
                                <a v-if="['link1', 'link2'].includes(_message?.entity?.type)" :href="_message.entity.ext.href" target="_blank" @click="(e)=>{e.stopPropagation()}">{{ _message.entity.text }}</a>
                                <code v-else-if="_message?.entity?.type === 'inlinecode'">{{ _message.entity.text }}</code>
                                <strong v-else-if="_message?.entity?.type === 'bold_italic'"><em>{{ _message.entity.text }}</em></strong>
                                <strong v-else-if="_message?.entity?.type === 'bold'">{{ _message.entity.text }}</strong>
                                <em v-else-if="_message?.entity?.type === 'italic'">{{ _message.entity.text }}</em>
                                <del v-else-if="_message?.entity?.type === 'delete'">{{ _message.entity.text }}</del>
                            </template>
                        </template>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-sm" style="width: 2rem; height: 2rem" @click="message.originalMode=!message.originalMode">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" fill="currentColor" class="bi bi-markdown-fill" viewBox="0 0 16 16">
                                <path v-if="message.originalMode" d="M14 3a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zM2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" />
                                <path v-if="message.originalMode" fill-rule="evenodd" d="M9.146 8.146a.5.5 0 0 1 .708 0L11.5 9.793l1.646-1.647a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 0-.708" />
                                <path v-if="message.originalMode" fill-rule="evenodd" d="M11.5 5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 1 .5-.5" />
                                <path v-if="message.originalMode" d="M3.56 11V7.01h.056l1.428 3.239h.774l1.42-3.24h.056V11h1.073V5.001h-1.2l-1.71 3.894h-.039l-1.71-3.894H2.5V11z" />
                                <path
                                    v-else
                                    d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm11.5 1a.5.5 0 0 0-.5.5v3.793L9.854 8.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L12 9.293V5.5a.5.5 0 0 0-.5-.5M3.56 7.01h.056l1.428 3.239h.774l1.42-3.24h.056V11h1.073V5.001h-1.2l-1.71 3.894h-.039l-1.71-3.894H2.5V11h1.06z"
                                />
                            </svg>
                        </button>
                        <button class="btn btn-sm ms-1" style="width: 2rem; height: 2rem" @click="writeClipboardText">
                            <svg v-if="copied" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0" />
                            </svg>
                            <svg v-else xmlns="http://www.w3.org/2000/svg" width="1rem" height="1rem" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div v-else>
                    <h1 class="text-center mb-2">
                        <div style="display: inline-block; transform: translateY(-0.1em)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 32 32">
                                <g fill="none">
                                    <path fill="#FF822D" d="M12.5 27.5c.448 1.442 1.838 2.5 3.5 2.5c1.663 0 3.052-1.058 3.5-2.5z" />
                                    <path fill="#FFB02E" d="M16 6.55c-.69 0-1.25-.56-1.25-1.25V3.25a1.25 1.25 0 0 1 2.5 0V5.3c0 .69-.56 1.25-1.25 1.25" />
                                    <path
                                        fill="#F9C23C"
                                        d="M27.6 22.843c-.96-.773-1.54-1.927-1.78-3.15l-1.73-8.9C23.32 6.85 19.94 4.01 16 4c-3.94.01-7.32 2.85-8.09 6.793l-1.73 8.9c-.24 1.223-.82 2.377-1.78 3.15a3.783 3.783 0 0 0-1.4 2.95v1.234c0 .542.43.973.95.973h24.1c.53 0 .95-.431.95-.973v-1.234c0-1.204-.55-2.258-1.4-2.95"
                                    />
                                </g>
                            </svg>
                        </div>
                        <span>TinyPush</span>
                    </h1>
                    <button v-if="pushStatus === 'default'" class="btn btn-primary mb-2" @click="initPushConfig" style="width: 100%">Subscribe</button>
                    <button v-if="pushStatus === 'granted'" class="btn btn-danger mb-2" @click="unSubscribe" style="width: 100%">Unsubscribe</button>
                    <p v-else-if="pushStatus === 'no'" class="text-center">The browser does not support notifications.</p>
                    <p v-else-if="pushStatus === 'denied'" class="text-center">Please allow the browser to use notification.</p>
                    <p class="text-center">If on iOS, add this page to the Home Screen for it to work.</p>

                    <details v-if="['granted', 'default'].includes(pushStatus)">
                        <summary class="text-center">Send Message</summary>
                        <div class="mb-3 mt-2">
                            <label class="form-label" for="uuid">UUID</label>
                            <div class="input-group">
                                <input id="uuid" type="text" class="form-control" v-model="uuid" aria-describedby="restore-uuid" />
                                <button class="btn btn-secondary" type="button" id="restore-uuid" @click="restoreUUID">Restore</button>
                            </div>
                            <div class="form-text" id="form-text-uuid">The message will be pushed to the device corresponding to the uuid</div>
                        </div>
                        <hr />

                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between" for="message">
                                <span class="me-1">Message</span>
                                <div v-if="push_status === 1" class="spinner-border spinner-border-sm" style="display: inline-block" role="status">
                                    <span class="visually-hidden">Sending...</span>
                                </div>
                                <span v-else-if="push_status === 2">‚úÖ</span>
                                <span v-else-if="push_status === 3">‚ùå</span>
                            </label>
                            <div class="input-group">
                                <textarea rows="5" id="message" class="form-control" v-model="push_message"></textarea>
                            </div>
                        </div>
                        <hr />
                        <details class="mb-3">
                            <summary>Logs</summary>
                            <ul>
                                <li v-for="(log, i) in push_logs" :key="i">{{ log }}</li>
                            </ul>
                            <hr />
                        </details>
                        <button v-if="pushStatus === 'granted'" class="btn btn-danger mb-2" @click="sendPush" style="width: 100%">PUSH!</button>
                    </details>
                    <p class="text-end"><span @click="pushState({ name: 'help' }, './#/help')" role="button" class="me-2">#help</span><span @click="pushState({ name: 'about' }, './#/about')" role="button">#about</span></p>
                </div>
            </div>
        </div>
        <!--load css and js-->
        <script src="https://cdn.jsdelivr.net/npm/vue@3.4.24/dist/vue.global.prod.js" integrity="sha256-NuLZKbx8rSWxfBrjvEqgCUKQ+dIBM3WUKEOAqw/NfIw=" crossorigin="anonymous"></script>
        <script>
            const endpoint = '.'
            const { createApp } = Vue
            createApp({
                data: () => ({
                    pushStatus: '',
                    vapid: '',
                    uuid: '',
                    push_message: '',
                    push_status: 0, // 0->idle, 1->sending, 2->success, 3->failed
                    push_logs: [],

                    message: {
                        content: '',
                        sign: '',
                        verify: false,
                        timestamp: 0
                    },
                    route: ['main'],
                    copied: false
                }),

                computed: {
                    messageObject() {
                        if (this.message.content === '') {
                            return []
                        }
                        const entities = this.parseMarkdown(this.message.content)
                        return this.newMessageObject(this.message.content, entities)
                    },
                    messageDate() {
                        if (!this.message.timestamp) {
                            return ''
                        }
                        try {
                            const tmpDate = new Date(this.message.timestamp)
                            //4:22 PM ¬∑ 19 Aug, 2022
                            return `${tmpDate.getFullYear()}-${(tmpDate.getMonth() + 1).toString().padStart(2, '0')}-${tmpDate.getDate().toString().padStart(2, '0')} ¬∑ ${tmpDate.getHours()}:${tmpDate
                                .getMinutes()
                                .toString()
                                .padStart(2, '0')}:${tmpDate.getSeconds().toString().padStart(2, '0')}`
                        } catch (e) {
                            console.error(e)
                            return ''
                        }
                    }
                },
                watch: {
                    async vapid(newVal, oldVal) {
                        if (newVal != '' && this.route?.[0] === 'preview') {
                            const signPayload = new URLSearchParams({ content: this.message.content || '', timestamp: String(this.message.timestamp || 0) }).toString()
                            this.message.verify = await this.verifySign(signPayload, this.message.sign || '')
                        }
                    },
                    async route(newVal, oldVal) {
                        if (newVal.length < 1) {
                            return
                        }
                        switch (newVal[0]) {
                            case 'preview':
                                const hashContent = JSON.parse(atob(newVal[1]))
                                const content = new TextDecoder('utf-8').decode(this.base64_to_buffer(this.base64url_to_base64(hashContent.content)))
                                //console.log(hashContent, content)
                                const signPayload = new URLSearchParams({ content, timestamp: String(hashContent?.timestamp || 0) }).toString()

                                this.message = { content, sign: hashContent?.sign || '', verify: await this.verifySign(signPayload, hashContent?.sign || ''), timestamp: Number(hashContent?.timestamp || 0) }
                                break
                            case 'about':
                                this.message = {
                                    content: `TinyPush is a tiny tool to push content via WebPush üöÄ\n\n1Ô∏è‚É£ Click on text to display original text\n\n2Ô∏è‚É£ A ‚úÖ displayed in the lower right corner indicates that the signature verification has been passed.\n\n3Ô∏è‚É£ Click **Send Message** on the homepage to view the content. After entering the content in message, click **PUSH!** to push the test message.\n\n4Ô∏è‚É£ Please keep the uuid safe, anyone with a uuid can push messages to this device. If the uuid is leaked, please re-apply for a subscription after unsubscribing on the homepage.\n\n5Ô∏è‚É£ Supported markdown syntax: [üîîTinyPush](https://push.nest.moe), <https://push.nest.moe>, \`const inlinecode = true\`, **Bold**, *Italic*, ***Bold & Italic***, ~~Delete~~. Nested syntax is not yet supported.\n\n6Ô∏è‚É£ It is expected that there is no push permission after viewing the notification on the iOS device. Just click the **subscribe** button directly, which will not cause the \`uuid\` to be modified.\n\nOur code repository is [github:BANKA2017/tiny-push](https://github.com/BANKA2017/tiny-push)\n`,
                                    sign: 'build-in',
                                    verify: true
                                }
                                break
                            case 'help':
                                this.message = {
                                    content: 'step by step...\n\n`uuid="" # Get the uuid from the target client`\n`message="" # What to push`\n`curl -XPOST "https://push.nest.moe/push/$uuid" -d "message=$message"`\n',
                                    sign: 'build-in',
                                    verify: true
                                }
                            case 'import':
                                break
                            case 'main':
                                this.message = { content: '', sign: '', verify: false, timestamp: 0 }
                                break
                        }
                        //console.log(newVal, oldVal)
                    }
                },

                mounted: async function () {
                    this.updateNotifitionPermission()
                    this.subscribeStatus()
                    this.uuid = localStorage.getItem('push:uuid') || ''

                    this.routerCase(location.hash)
                    addEventListener('popstate', (event) => {
                        this.updateNotifitionPermission()
                        this.subscribeStatus()
                        this.routerCase(event.target.location.hash)
                    })

                    fetch(endpoint + '/vapid')
                        .then((res) => res.json())
                        .then(async (res) => {
                            this.vapid = res.data.vapid
                        })
                        .catch((e) => {
                            console.error(e)
                        })
                },
                methods: {
                    routerCase: function (to) {
                        if (!to) {
                            to = this.route = ['main']
                            return
                        }
                        to = to.split('#')
                        if (to.length < 2) {
                            return // invalid path
                        }
                        to = to.slice(1).join('').split('/')
                        if (!to[1]) {
                            return // invalid path
                        } else {
                            this.route = to.slice(1)
                        }
                    },
                    updateNotifitionPermission: function () {
                        if (!('Notification' in window)) {
                            this.pushStatus = 'no'
                        } else {
                            this.pushStatus = Notification.permission
                        }
                    },
                    initPushConfig: function () {
                        switch (this.pushStatus) {
                            case 'no':
                            case 'granted':
                                return
                            case 'default':
                                Notification.requestPermission().then((permission) => {
                                    this.pushStatus = permission
                                    if (!this.uuid) {
                                        this.subscribe()
                                    }
                                })
                            case 'denied':
                                return
                        }
                    },
                    subscribeStatus: function () {
                        if (!('serviceWorker' in navigator)) {
                            console.error('Not support')
                            return
                        }
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager.getSubscription().then((subscription) => {
                                if (!subscription) {
                                    this.pushStatus = 'default'
                                }
                            })
                        })
                    },
                    subscribe: function () {
                        if (!('serviceWorker' in navigator)) {
                            console.error('Not support')
                            return
                        }
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager
                                .subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: this.vapid
                                })
                                .then((sub) => {
                                    sub = sub.toJSON()
                                    fetch(endpoint + '/subscribe/', {
                                        headers: {
                                            'content-type': 'application/x-www-form-urlencoded'
                                        },
                                        method: 'PUT',
                                        body: new URLSearchParams({
                                            endpoint: sub.endpoint,
                                            p256dh: sub.keys.p256dh,
                                            auth: sub.keys.auth
                                        }).toString()
                                    })
                                        .then((res) => res.json())
                                        .then((res) => {
                                            //console.log(res, res.code, res.data)
                                            if (res.code === 200) {
                                                this.uuid = res.data.uuid
                                                localStorage.setItem('push:uuid', this.uuid)
                                            }
                                        })
                                })
                        })
                    },
                    unSubscribe: function () {
                        if (!('serviceWorker' in navigator)) {
                            console.error('Not support')
                            return
                        }
                        navigator.serviceWorker.ready.then((reg) => {
                            if (!reg.pushManager) {
                                console.error('Not support')
                                return
                            }
                            reg.pushManager
                                .getSubscription()
                                .then((subscription) => {
                                    subscription.unsubscribe().then((successful) => {
                                        if (this.uuid) {
                                            fetch(endpoint + '/subscribe/' + this.uuid, {
                                                headers: {
                                                    'content-type': 'application/x-www-form-urlencoded'
                                                },
                                                method: 'DELETE'
                                            })
                                                .then((res) => res.json())
                                                .then((res) => {
                                                    //console.log(res)
                                                })
                                                .catch((e) => {
                                                    console.error(res)
                                                })
                                        }
                                    })
                                    localStorage.removeItem('push:uuid')
                                    this.uuid = ''
                                    this.pushStatus = 'default'
                                })
                                .catch((e) => {
                                    console.error(e)
                                })
                        })
                    },
                    download: function (filename, text) {
                        let element = document.createElement('a')
                        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text))
                        element.setAttribute('download', filename)
                        element.style.display = 'none'
                        document.body.appendChild(element)
                        element.click()
                        document.body.removeChild(element)
                    },
                    base64_to_base64url: (base64) => base64.replaceAll('/', '_').replaceAll('+', '-').replaceAll('=', ''),
                    base64url_to_base64: (base64url) => base64url.replaceAll('_', '/').replaceAll('-', '+'),
                    base64_to_buffer: function (base64) {
                        let binaryString = atob(base64)
                        let bytes = new Uint8Array(binaryString.length)
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i)
                        }
                        return bytes.buffer
                    },
                    sendPush: function () {
                        if (!this.uuid) {
                            return
                        }
                        this.push_status = 1
                        fetch(endpoint + '/push/' + this.uuid, {
                            headers: {
                                'content-type': 'application/x-www-form-urlencoded'
                            },
                            method: 'POST',
                            body: new URLSearchParams({
                                message: this.push_message
                            }).toString()
                        })
                            .then((res) => res.json())
                            .then((res) => {
                                this.push_status = res.code === 200 ? 2 : 3
                                this.push_logs.unshift({
                                    response: res
                                })
                                console.log(res)
                                setTimeout(() => {
                                    this.push_status = 0
                                }, 1500)
                            })
                            .catch((e) => {
                                this.push_status = 3
                                console.error(e)
                                setTimeout(() => {
                                    this.push_status = 0
                                }, 1500)
                            })
                    },
                    clickEvent: function (e, callback = () => {}) {
                        let selectionObject = window.getSelection()
                        if (selectionObject && selectionObject.isCollapsed) {
                            callback()
                        }
                    },
                    verifySign: async function (content = '', sign = '') {
                        if (!sign || !this.vapid) {
                            return false
                        }
                        const publicKey = await crypto.subtle.importKey(
                            'raw',
                            this.base64_to_buffer(this.base64url_to_base64(this.vapid)),
                            {
                                name: 'ECDSA',
                                namedCurve: 'P-256'
                            },
                            true,
                            ['verify']
                        )
                        return await crypto.subtle.verify(
                            {
                                name: 'ECDSA',
                                hash: { name: 'SHA-256' }
                            },
                            publicKey,
                            this.base64_to_buffer(this.base64url_to_base64(sign)),
                            new TextEncoder().encode(content)
                        )
                    },
                    parseMarkdown: function (str = '') {
                        if (!str) {
                            return []
                        }
                        const matchLinks = this.PregMatchAll(/\[([^\]]+)\]\(([^)]+)\)|<([^>]+)>|`([^`]+)`|\*{3}([^\*]+)\*{3}|\*{2}([^\*]+)\*{2}|\*{1}([^\*]+)\*{1}|~{2}([^~]+)~{2}/g, str)
                        const entities = []
                        let position = 0
                        for (const i in matchLinks[0]) {
                            position = str.indexOf(matchLinks[0][i], position)
                            const valueIndex = matchLinks.slice(1).findIndex((v) => v[i] !== undefined)
                            let valueType = 'link1'
                            switch (valueIndex) {
                                case 2:
                                    valueType = 'link2'
                                    break
                                case 3:
                                    valueType = 'inlinecode'
                                    break
                                case 4:
                                    valueType = 'bold_italic'
                                    break
                                case 5:
                                    valueType = 'bold'
                                    break
                                case 6:
                                    valueType = 'italic'
                                    break
                                case 7:
                                    valueType = 'delete'
                                    break
                            }
                            const rename = matchLinks[2][i] !== undefined
                            let entity = {
                                type: valueType,
                                text: matchLinks[valueIndex + 1][i],
                                position,
                                length: matchLinks[0][i].length
                            }
                            if (['link1', 'link2'].includes(valueType)) {
                                entity.ext = {
                                    href: matchLinks[valueType === 'link1' ? 2 : 3][i]
                                }
                            }
                            entities.push(entity)
                            position += matchLinks[0][i].length
                        }
                        return entities
                    },
                    newMessageObject: function (str = '', entities = []) {
                        const strLength = str.length
                        const newArray = []
                        let position = 0
                        for (const entity of entities) {
                            newArray.push({
                                str: str.slice(position, entity.position),
                                entity
                            })
                            position = entity.position + entity.length
                        }
                        if (position < strLength) {
                            newArray.push({
                                str: str.slice(position)
                            })
                        }
                        return newArray
                    },
                    PregMatchAll: (regex = new RegExp('', 'gm'), text = '') => {
                        let handle
                        let match = []

                        while ((handle = regex.exec(text)) !== null) {
                            // This is necessary to avoid infinite loops with zero-width matches
                            if (handle.index === regex.lastIndex) {
                                regex.lastIndex++
                            }
                            for (const index in handle) {
                                if (!isNaN(index)) {
                                    if (!match[index]) {
                                        match[index] = []
                                    }
                                    match[index].push(handle[index])
                                }
                            }
                        }
                        return match
                    },
                    pushState: function (state = {}, url) {
                        state = { ...state, url }
                        history.pushState(state, '', url)
                        dispatchEvent(new PopStateEvent('popstate', { state }))
                    },
                    restoreUUID: function () {
                        this.uuid = localStorage.getItem('push:uuid')
                    },
                    writeClipboardText: async function () {
                        try {
                            await navigator.clipboard.writeText(this.message.content)
                            this.copied = true
                            setTimeout(() => {
                                this.copied = false
                            }, 1500)
                        } catch (error) {
                            console.error(error.message)
                        }
                    }
                }
            }).mount('#app')
        </script>
        <script async>
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('./sw.js')
                    .then((reg) => {
                        //console.log('register a service worker: ', reg)
                    })
                    .catch((err) => {
                        console.error('err: ', err)
                    })
            }
        </script>
    </body>
</html>
